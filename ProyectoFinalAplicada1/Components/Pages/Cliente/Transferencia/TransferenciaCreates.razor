@page "/Transferencia/Create"

@using System.Security.Claims
@using Microsoft.EntityFrameworkCore

@rendermode InteractiveServer
@inject TranferenciaServices transferenciaServices
@inject NavigationManager navigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ProyectoFinalAplicada1.DAL.Context _context

<PageTitle>Crear Transferencia</PageTitle>

<EditForm Model="Transferencia" OnValidSubmit="Guardar">
    <DataAnnotationsValidator />

    <div class="container">
        <div class="card shadow-lg">
            <div class="card-header text-center">
                <h5 class="card-title">Nueva Transferencia</h5>
            </div>

            <div class="card-body">
                @* Origen *@
                <div class="mb-3">
                    <label class="form-label"><strong>Banco de Origen</strong></label>
                    <InputSelect class="form-select" @bind-Value="Transferencia.Origen">
                        <option value="" selected disabled>-- Seleccione --</option>
                        <option value="Banreservas">Banreservas</option>
                        <option value="Popular">Popular</option>
                        <option value="BHD">BHD</option>
                        <option value="Qik">Qik - Banco digital</option>
                    </InputSelect>
                    <ValidationMessage For="(() => Transferencia.Origen)" />
                </div>

                @* Destino *@
                <div class="mb-3">
                    <label class="form-label"><strong>Banco de Destino</strong></label>
                    <InputSelect class="form-select" @bind-Value="Transferencia.Destino">
                        <option value="" selected disabled>-- Seleccione --</option>
                        <option value="Banreservas">Banreservas</option>
                        <option value="Popular">Popular</option>
                        <option value="BHD">BHD</option>
                        <option value="Qik">Qik - Banco digital</option>
                    </InputSelect>
                    <ValidationMessage For="(() => Transferencia.Destino)" />
                </div>

                @* Monto *@
                <div class="mb-3">
                    <label class="form-label"><strong>Monto</strong></label>
                    <InputNumber class="form-control" @bind-Value="Transferencia.Monto" />
                    <ValidationMessage For="(() => Transferencia.Monto)" />
                </div>

                @* Observaciones *@
                <div class="mb-3">
                    <label class="form-label"><strong>Observaciones</strong></label>
                    <InputTextArea class="form-control" @bind-Value="Transferencia.Observaciones" />
                    <ValidationMessage For="(() => Transferencia.Observaciones)" />
                </div>

                <div class="alert alert-secondary text-center">
                    <small>Nota: Podrá adjuntar la imagen del comprobante en el siguiente paso.</small>
                </div>
            </div>

            <div class="card-footer text-center mt-2">
                <a href="/Transferencia/Index" class="btn btn-secondary">
                    <span class="bi bi-arrow-left"></span> Volver
                </a>
                <button type="submit" class="btn btn-primary bi bi-floppy"> Guardar</button>
            </div>
        </div>
    </div>
</EditForm>

<div class="text-center text-danger mt-2">
    @Mensaje
</div>

@code {
    public Transferencia Transferencia { get; set; } = new Transferencia();
    public string Mensaje { get; set; } = string.Empty;
    private string UserId { get; set; } = string.Empty;
    public int IdCliente { get; set; }

    protected override async Task OnInitializedAsync()
    {
        // 1. OBTENEMOS EL USUARIO LOGUEADO
        IdCliente = await GetClienteIdAsync();
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            // Buscamos el ID del usuario (Claim "sub" o NameIdentifier)
            UserId = user.FindFirst(c => c.Type.Contains("nameidentifier"))?.Value ?? "";
        }
        else
        {
            Mensaje = "Error: Usuario no autenticado.";
        }
    }
    public async Task<int> GetClienteIdAsync()
    {
        // 1. Obtener el GUID (Identity User ID)
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var identityId = authState.User
            .FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        if (string.IsNullOrEmpty(identityId))
        {
            return 0; // Usuario no logueado o ID no encontrado
        }

        // 2. Consultar la base de datos para obtener el ClienteId
        return await _context.Cliente
            .Where(c => c.UserId == identityId)
            .Select(c => c.ClienteId) // Selecciona solo el ClienteId
            .FirstOrDefaultAsync();    // Devuelve el ID (o 0 si no se encuentra)
    }

    public async Task Guardar()
    {
        if (string.IsNullOrEmpty(UserId))
        {
            Mensaje = "No se puede guardar: No se identificó al usuario.";
            return;
        }

        // 2. LLAMAMOS AL NUEVO MÉTODO PASANDO EL USERID
        var guardado = await transferenciaServices.Guardar(Transferencia, IdCliente);

        if (guardado)
        {
            // Redirigir a Edit para subir la foto
            navigationManager.NavigateTo($"/Transferencia/Edit/{Transferencia.TransferenciaId}");
        }
        else
        {
            Mensaje = "No se pudo guardar. Asegúrese de tener un Perfil de Cliente registrado.";
        }
    }
}